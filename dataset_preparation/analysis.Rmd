---
title: Analysis of Available Data
output: pdf_document
---

# Load the corpora

```{r}
library(tidyverse)
library(tidymodels)
library(jsonlite)

set.seed(42)

load_KUK_subcorpus_metadata <- function(crp) {
  read_tsv(paste(c(
    "../corpora/KUK_1.0/metadata/", crp, "_DocumentFileFormat.tsv"
  ), collapse = "")) %>%
    filter(FileFormat == "TXT") %>%
    full_join(
      read_tsv(paste(c(
        "../corpora/KUK_1.0/metadata/",
        crp,
        "_DocumentIdentificationGenreProperties.tsv"
      ), collapse = "")),
      by = "KUK_ID"
    ) %>%
    mutate(across(where(is.numeric), as.character)) %>%
    mutate(subcorpus = crp) %>%
    select(KUK_ID, FileName, FileFormat, FolderPath, subcorpus, everything())
}

kuky_orig <- fromJSON("../corpora/KUKY/argumentative.json")$documents %>%
  as.data.frame() %>%
  bind_rows(
    fromJSON("../corpora/KUKY/normative.json")$documents %>% as.data.frame()
  ) %>%
  rename(KUK_ID = doc_id) %>%
  select(!c(plainText, doc_name)) %>%
  select(KUK_ID, everything())

kuky_kuk <- load_KUK_subcorpus_metadata("KUKY") %>%
  filter(FolderPath == "data/KUKY/TXT")

kuky <- kuky_kuk %>% full_join(kuky_orig, by = "KUK_ID")
czcdc <- load_KUK_subcorpus_metadata("CzCDC")
eso <- load_KUK_subcorpus_metadata("ESO")
frbo <- load_KUK_subcorpus_metadata("FrBo")
lifrlaw <- load_KUK_subcorpus_metadata("LiFRLaw")
ombuflyers <- load_KUK_subcorpus_metadata("OmbuFlyers")

df <- bind_rows(kuky, czcdc) %>%
  bind_rows(eso) %>%
  bind_rows(frbo) %>%
  bind_rows(lifrlaw) %>%
  bind_rows(ombuflyers)

str(df)
```

# Filter out duplicates

Some subcorpora overlap (*FrBo* with *ESO*, and multiple subcorpora with *KUKY*).

The usage of documents with ClarityPursuit == NA is questionable, let's exclude such documents. This effectively comes with a price of excluding the whole *eso* subcorpus. 

The usage of documents with ClarityPursuit == TRUE is also questionable as they're not reviewed in the same manner as the documents from KUKY, yet at the same time they are less likely to be as "unreadable" as the documents with ClarityPursuit == FALSE. Such documents could very well be readable, interfering with the training process.

After filtering ClarityPursuit == NA out, the only remaining overlaps are with *KUKY*. Let's keep the documents from *KUKY* as they are associated with a more careful readability evaluation.

```{r}
df %>%
  group_by(FileName) %>%
  mutate(n = n()) %>%
  filter(n > 1) %>%
  select(FileName, subcorpus, Readability, ClarityPursuit) %>%
  arrange(FileName) %>%
  print(n = 80)

df <- df %>%
  filter(!is.na(Readability) | !is.na(ClarityPursuit)) %>%
  filter(ClarityPursuit == FALSE | is.na(ClarityPursuit))

df <- df %>%
  group_by(FileName) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  filter(n == 1 | !is.na(Readability)) %>%
  select(-n)
```

The dataset is now free of overlaps.

# Prepare for ML

```{r}
df <- df %>% mutate(positive_class = Readability %in% c("high", "medium"))

readable <- df %>% filter(positive_class)
unreadable <- df %>% filter(!positive_class)

str(readable)
str(unreadable)

df_split <- df %>% initial_split(prop = 4 / 5)
training_set <- training(df_split)
evaluation_set <- testing(df_split)
```